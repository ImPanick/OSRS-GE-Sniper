<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSRS GE Sniper - Volume Tracker</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <h1>üìä Volume Tracker</h1>
  
  <nav>
    <a href="/dashboard">üìä Dashboard</a>
    <a href="/volume_tracker" class="active">üìà Volume Tracker</a>
    <a href="/admin">üîí Admin</a>
  </nav>

  <div style="max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
    <div class="stats">
      <div class="stat-box">
        <h3>Total Items</h3>
        <div class="value" id="totalItems">0</div>
      </div>
      <div class="stat-box">
        <h3>Filtered Items</h3>
        <div class="value" id="filteredItems">0</div>
      </div>
      <div class="stat-box">
        <h3>Avg Volume</h3>
        <div class="value" id="avgVolume">0</div>
      </div>
      <div class="stat-box">
        <h3>Avg Profit</h3>
        <div class="value" id="avgProfit">0</div>
      </div>
    </div>

    <div class="filters">
      <h2>üîç Filters</h2>
      <div class="filter-row">
        <div class="filter-group">
          <label>Min Volume</label>
          <input type="number" id="minVolume" value="0" min="0">
        </div>
        <div class="filter-group">
          <label>Max Volume</label>
          <input type="number" id="maxVolume" value="" placeholder="No limit">
        </div>
        <div class="filter-group">
          <label>Min Buy Price</label>
          <input type="number" id="minBuyPrice" value="0" min="0">
        </div>
        <div class="filter-group">
          <label>Max Buy Price</label>
          <input type="number" id="maxBuyPrice" value="" placeholder="No limit">
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-group">
          <label>Min Profit</label>
          <input type="number" id="minProfit" value="" placeholder="No limit">
        </div>
        <div class="filter-group">
          <label>Min ROI %</label>
          <input type="number" id="minROI" value="" placeholder="No limit" step="0.1">
        </div>
        <div class="filter-group">
          <label>Max Risk Score</label>
          <input type="number" id="maxRisk" value="" placeholder="No limit" step="0.1" max="100">
        </div>
        <div class="filter-group">
          <label>Min Confidence %</label>
          <input type="number" id="minConfidence" value="" placeholder="No limit" step="0.1" max="100">
        </div>
        <div class="filter-group">
          <label>Sort By</label>
          <select id="sortBy">
            <option value="volume">Volume</option>
            <option value="profit">Profit</option>
            <option value="roi">ROI %</option>
            <option value="risk_score">Risk Score</option>
            <option value="profitability_confidence">Confidence</option>
            <option value="liquidity_score">Liquidity</option>
            <option value="buy">Buy Price</option>
            <option value="sell">Sell Price</option>
            <option value="name">Name</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Sort Order</label>
          <select id="sortOrder">
            <option value="desc">Descending</option>
            <option value="asc">Ascending</option>
          </select>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-group">
          <label>Search Item Name</label>
          <input type="text" id="searchName" placeholder="Filter by name...">
        </div>
        <div class="filter-group">
          <label>Items Per Page</label>
          <select id="itemsPerPage">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
            <option value="500">500</option>
          </select>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table id="itemsTable">
        <thead>
          <tr>
            <th data-sort="name">Item Name</th>
            <th data-sort="volume">Volume</th>
            <th data-sort="buy">Buy Price</th>
            <th data-sort="insta_buy">Insta Buy</th>
            <th data-sort="sell">Sell Price</th>
            <th data-sort="insta_sell">Insta Sell</th>
            <th data-sort="profit">Profit</th>
            <th data-sort="roi">ROI %</th>
            <th>Limit</th>
            <th data-sort="risk_score">Risk</th>
            <th data-sort="profitability_confidence">Confidence</th>
            <th data-sort="liquidity_score">Liquidity</th>
          </tr>
        </thead>
        <tbody id="itemsBody">
          <tr>
            <td colspan="12" style="text-align:center; padding: 2rem;">
              <div class="loading" style="margin: 0 auto;"></div>
              <p style="margin-top: 1rem; color: var(--text-muted);">Loading items...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination">
      <button id="prevPage" onclick="changePage(-1)">‚óÄ Previous</button>
      <span id="pageInfo">Page 1 of 1</span>
      <button id="nextPage" onclick="changePage(1)">Next ‚ñ∂</button>
    </div>
  </div>

  <footer>
    <p>Auto-refreshes every 10 seconds ‚Ä¢ Last updated: <span id="lastUpdate"></span></p>
  </footer>

  <script>
    let allItems = [];
    let filteredItems = [];
    let currentPage = 1;
    let itemsPerPage = 100;
    let sortBy = 'volume';
    let sortOrder = 'desc';
    let currentSort = null;

    async function loadItems() {
      try {
        const response = await fetch('/api/all_items');
        if (!response.ok) throw new Error('Failed to fetch items');
        allItems = await response.json();
        applyFilters();
      } catch (e) {
        console.error('Error loading items:', e);
        document.getElementById('itemsBody').innerHTML = 
          '<tr><td colspan="12" style="text-align:center;color:var(--accent-danger);padding:2rem;">Error loading items. Please refresh the page.</td></tr>';
      }
    }

    function applyFilters() {
      const minVolume = parseInt(document.getElementById('minVolume').value) || 0;
      const maxVolume = parseInt(document.getElementById('maxVolume').value) || Infinity;
      const minBuyPrice = parseInt(document.getElementById('minBuyPrice').value) || 0;
      const maxBuyPrice = parseInt(document.getElementById('maxBuyPrice').value) || Infinity;
      const minProfit = parseInt(document.getElementById('minProfit').value) || -Infinity;
      const minROI = parseFloat(document.getElementById('minROI').value) || -Infinity;
      const maxRisk = parseFloat(document.getElementById('maxRisk').value) || Infinity;
      const minConfidence = parseFloat(document.getElementById('minConfidence').value) || -Infinity;
      const searchName = document.getElementById('searchName').value.toLowerCase();

      filteredItems = allItems.filter(item => {
        return item.volume >= minVolume &&
               item.volume <= maxVolume &&
               item.buy >= minBuyPrice &&
               item.buy <= maxBuyPrice &&
               item.profit >= minProfit &&
               item.roi >= minROI &&
               (item.risk_score || 0) <= maxRisk &&
               (item.profitability_confidence || 0) >= minConfidence &&
               item.name.toLowerCase().includes(searchName);
      });

      sortItems();
      updateStats();
      renderTable();
    }

    function sortItems() {
      sortBy = document.getElementById('sortBy').value;
      sortOrder = document.getElementById('sortOrder').value;
      
      filteredItems.sort((a, b) => {
        let aVal = a[sortBy];
        let bVal = b[sortBy];
        
        if (aVal === null || aVal === undefined) aVal = 0;
        if (bVal === null || bVal === undefined) bVal = 0;
        
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }
        
        if (sortOrder === 'asc') {
          return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
        } else {
          return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
        }
      });
    }

    function updateStats() {
      document.getElementById('totalItems').textContent = allItems.length.toLocaleString();
      document.getElementById('filteredItems').textContent = filteredItems.length.toLocaleString();
      
      if (filteredItems.length > 0) {
        const avgVolume = Math.round(filteredItems.reduce((sum, i) => sum + (i.volume || 0), 0) / filteredItems.length);
        const avgProfit = Math.round(filteredItems.reduce((sum, i) => sum + (i.profit || 0), 0) / filteredItems.length);
        document.getElementById('avgVolume').textContent = avgVolume.toLocaleString();
        document.getElementById('avgProfit').textContent = (avgProfit / 1e6).toFixed(1) + 'M';
      } else {
        document.getElementById('avgVolume').textContent = '0';
        document.getElementById('avgProfit').textContent = '0';
      }
    }

    function renderTable() {
      itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
      const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
      currentPage = Math.max(1, Math.min(currentPage, totalPages));
      
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = filteredItems.slice(start, end);

      const tbody = document.getElementById('itemsBody');
      tbody.innerHTML = '';

      if (pageItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:2rem;color:var(--text-muted);">No items match filters</td></tr>';
        updatePagination(totalPages);
        return;
      }

      pageItems.forEach(item => {
        const row = document.createElement('tr');
        const instaBuyDiff = item.insta_buy !== item.buy;
        const instaSellDiff = item.insta_sell !== item.sell;
        
        const riskScore = item.risk_score || 0;
        const riskLevel = item.risk_level || 'UNKNOWN';
        let riskColor = 'var(--accent-success)';
        if (riskScore >= 60) riskColor = 'var(--accent-danger)';
        else if (riskScore >= 40) riskColor = 'var(--accent-warning)';
        else if (riskScore >= 20) riskColor = '#ff8800';
        
        const confidence = item.profitability_confidence || 0;
        const confidenceColor = confidence >= 70 ? 'var(--accent-success)' : confidence >= 40 ? 'var(--accent-warning)' : 'var(--accent-danger)';
        
        const liquidity = item.liquidity_score || 0;
        const liquidityColor = liquidity >= 70 ? 'var(--accent-success)' : liquidity >= 40 ? 'var(--accent-warning)' : 'var(--accent-danger)';
        
        row.innerHTML = `
          <td><a href="https://prices.runescape.wiki/osrs/item/${item.id}" target="_blank" style="color:var(--accent-primary);text-decoration:none;">${item.name}</a></td>
          <td class="volume-high">${(item.volume || 0).toLocaleString()}</td>
          <td class="price-buy">${(item.buy || 0).toLocaleString()}</td>
          <td class="price-insta ${instaBuyDiff ? 'price-buy' : ''}">${(item.insta_buy || 0).toLocaleString()}${instaBuyDiff ? ' ‚ö°' : ''}</td>
          <td class="price-sell">${(item.sell || 0).toLocaleString()}</td>
          <td class="price-insta ${instaSellDiff ? 'price-sell' : ''}">${(item.insta_sell || 0).toLocaleString()}${instaSellDiff ? ' ‚ö°' : ''}</td>
          <td class="${item.profit >= 0 ? 'profit-positive' : 'profit-negative'}">${((item.profit || 0) / 1e6).toFixed(2)}M</td>
          <td class="${item.roi >= 0 ? 'profit-positive' : 'profit-negative'}">${(item.roi || 0).toFixed(2)}%</td>
          <td>${(item.limit || 0).toLocaleString()}</td>
          <td style="color:${riskColor};font-weight:bold;">${riskLevel}<br><small style="color:var(--text-muted);">${riskScore.toFixed(1)}</small></td>
          <td style="color:${confidenceColor};font-weight:bold;">${confidence.toFixed(1)}%</td>
          <td style="color:${liquidityColor};font-weight:bold;">${liquidity.toFixed(1)}%</td>
        `;
        tbody.appendChild(row);
      });

      updatePagination(totalPages);
    }

    function updatePagination(totalPages) {
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage >= totalPages;
    }

    function changePage(delta) {
      const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderTable();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // Event listeners
    ['minVolume', 'maxVolume', 'minBuyPrice', 'maxBuyPrice', 'minProfit', 'minROI', 'maxRisk', 'minConfidence', 'searchName', 'sortBy', 'sortOrder', 'itemsPerPage'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', () => {
          currentPage = 1;
          applyFilters();
        });
        element.addEventListener('change', () => {
          currentPage = 1;
          applyFilters();
        });
      }
    });

    // Table header sorting
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const sortField = th.getAttribute('data-sort');
        if (sortBy === sortField) {
          sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
          sortBy = sortField;
          sortOrder = 'desc';
        }
        document.getElementById('sortBy').value = sortBy;
        document.getElementById('sortOrder').value = sortOrder;
        applyFilters();
      });
    });

    // Update time
    function updateTime() {
      const now = new Date();
      document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
    }
    updateTime();
    setInterval(updateTime, 1000);

    // Initial load
    loadItems();
    setInterval(loadItems, 10000);
  </script>
</body>
</html>
